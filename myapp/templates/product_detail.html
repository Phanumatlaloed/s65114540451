{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} | Shop</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'styles/product_detail.css' %}">
    <link rel="stylesheet" href="{% static 'styles/navbar.css' %}">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sriracha&display=swap" rel="stylesheet">

    <!-- Slick Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">
</head>
<body>

    <!-- Navbar -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="{% url 'home' %}">
                    <img src="{% static 'media/logo.jpg' %}" alt="Shop Logo">
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}" class="nav-link">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                <li><a href="{% url 'profile' request.user.id %}" class="nav-link">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a></li>
                <li><a href="{% url 'product_list' %}" class="nav-link {% if request.path == '/products/' %}active{% endif %}">üõçÔ∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                <li><a href="{% url 'order_history' %}" class="nav-link {% if request.path == '/order/history/' %}active{% endif %}">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                <li><a href="{% url 'cart' %}" class="nav-link {% if request.path == '/cart/' %}active{% endif %}">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</a></li>
            </ul>
        </nav>
    </header>

    <!-- Product Detail Section -->
    <div class="product-container">
        <div class="product-box">
            <!-- Product Image Slider -->
            <div class="product-slider">
                {% if product.image %}
                    <div><img src="{{ product.image.url }}" alt="{{ product.name }}"></div>
                {% endif %}
                {% for img in product.extra_images.all %}
                    <div><img src="{{ img.image.url }}" alt="Extra Image"></div>
                {% endfor %}
            </div>

            <!-- Product Details -->
            <div class="product-info">
                <h2>{{ product.name }}</h2>
                <p class="price">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{{ product.price|floatformat:2 }}</p>
                <p class="stock">
                    {% if product.stock > 0 %}
                        <span class="in-stock">
                            ‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á: {{ product.stock }} ‡∏ä‡∏¥‡πâ‡∏ô
                        </span>
                    {% else %}
                        <span class="out-of-stock">
                            ‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î
                        </span>
                    {% endif %}
                </p>
                <p class="sold">üî• ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: <span class="sold-count">{{ product.total_sold }}</span> ‡∏ä‡∏¥‡πâ‡∏ô</p>
                <p class="description">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {{ product.description }}</p>
                <p class="category">üìå ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: <span class="category-badge">{{ product.get_category_display }}</span></p>
                <p class="seller">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: 
                    <a href="{% url 'store_detail' product.seller.id %}" class="store-link">
                        <strong>{{ product.seller.store_name }}</strong>
                    </a>
                </p>

                <!-- Add to Cart -->
                <div class="cart-section">
                    {% if product.stock > 0 %}
                        <button type="button" class="btn btn-success add-to-cart-btn" data-product-id="{{ product.id }}">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" disabled>‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>
                    {% endif %}
                </div>
                
                <!-- Cart Message -->
                <div id="cart-message" style="display: none;"></div>
                
                <!-- Share Button -->
                <div class="share-section">
                    <button class="btn btn-info share-btn" onclick="shareProduct()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>

                <!-- Back Button -->
                <div class="cart-section">
                    <a href="{% url 'product_list' %}" class="btn btn-secondary back-btn">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
        <h3>üåü ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        {% for review in product.reviews.all %}
            <div class="review-box">
                <div class="review-header">
                    <p class="review-username"><strong>{{ review.user.username }}</strong></p>
                    <p class="rating rating-{% if review.rating >= 4 %}high{% elif review.rating >= 3 %}medium{% else %}low{% endif %}">
                        {% for i in "12345" %}
                            {% if forloop.counter <= review.rating %}‚≠ê{% else %}‚òÜ{% endif %}
                        {% endfor %}
                        {{ review.rating }}/5
                    </p>
                </div>
                <p class="review-meta">üõí ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô <strong>{{ review.order.seller.store_name }}</strong> ‚Ä¢ {{ review.created_at|date:"d M Y" }}</p>
                <p class="review-comment">{{ review.comment }}</p>
    
                <!-- ‚úÖ Show seller response if available -->
                {% get_review_response review.id as review_response %}
                {% if review_response %}
                    <div class="seller-response">
                        <p><strong>‚úçÔ∏è ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô {{ review_response.seller.store_name }}:</strong></p>
                        <p>{{ review_response.response_text }}</p>
                        <p class="response-date">üóìÔ∏è {{ review_response.created_at|date:"d M Y H:i" }}</p>
                    </div>
                {% endif %}
    
                <!-- Review Media -->
                <div class="review-media">
                    {% for media in review.media.all %}
                        {% if media.media_type == "image" %}
                            <img src="{{ media.file.url }}" alt="Review Image" class="review-image">
                        {% elif media.media_type == "video" %}
                            <video controls class="review-video">
                                <source src="{{ media.file.url }}" type="video/mp4">
                            </video>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <div class="empty-reviews">
                <p class="empty-title">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
                <p class="empty-subtitle">‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
            </div>
        {% endfor %}
    </div>

    <!-- Analyze Reviews Button -->
    <form action="{% url 'product_detail' product.id %}" method="post" class="center-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
                <line x1="2" y1="10" x2="6" y2="14"></line>
            </svg>
            ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
        </button>
    </form>
    
    <!-- Review Analysis Results -->
    {% if reviews %}
        <div class="reviews-section">
            <h3>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</h3>
            
            {% for review in reviews %}
                <div class="review-box">
                    <div class="review-header">
                        <p><strong>{{ review.user.username }}</strong></p>
                        <p class="rating rating-{% if review.rating >= 4 %}high{% elif review.rating >= 3 %}medium{% else %}low{% endif %}">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    ‚≠ê
                                {% else %}
                                    ‚òÜ
                                {% endif %}
                            {% endfor %}
                        </p>
                    </div>
                    <p class="review-comment">{{ review.comment }}</p>
            
                    <!-- Review Sentiment -->
                    {% if review.analysis_done %}
                        <p class="sentiment sentiment-{{ review.sentiment }}">
                            {% if review.sentiment == "positive" %}
                                üòä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å
                            {% elif review.sentiment == "negative" %}
                                üò° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö
                            {% else %}
                                üòê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Å‡∏•‡∏≤‡∏á
                            {% endif %}
                        </p>
                    {% else %}
                        <p class="sentiment sentiment-pending">
                            üü° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                        </p>
                    {% endif %}
                </div>
            {% endfor %}
            
            <!-- Review Summary -->
            {% if summary %}
                <div class="review-stats">
                    <h3>üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÇ‡∏î‡∏¢ AI</h3>
                    <p class="summary-text">{{ summary }}</p>
                    
                    <div class="stats-container">
                        <div class="stat-box stat-positive">
                            <p class="stat-label">üòä ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å</p>
                            <p class="stat-value">{{ positive_ratio|floatformat:1 }}%</p>
                        </div>
                        
                        <div class="stat-box stat-neutral">
                            <p class="stat-label">üòê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÜ</p>
                            <p class="stat-value">{{ neutral_ratio|floatformat:1 }}%</p>
                        </div>
                        
                        <div class="stat-box stat-negative">
                            <p class="stat-label">üò° ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö</p>
                            <p class="stat-value">{{ negative_ratio|floatformat:1 }}%</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}


    
    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script>
        $(document).ready(function(){
            $('.product-slider').slick({
                dots: true,
                infinite: true,
                speed: 300,
                slidesToShow: 1,
                adaptiveHeight: true
            });
    
            // üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏ö‡∏ö AJAX
            $(".add-to-cart-btn").click(function(event) {
                event.preventDefault();  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
    
                let productId = $(this).data("product-id");
                let cartMessage = $("#cart-message");
    
                $.ajax({
                    url: `/cart/add/${productId}/`,  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    dataType: "json",
                    success: function(response) {
                        if (response.success) {
                            $("#cart-count").text(response.cart_count); // üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                            cartMessage.text("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!").css("color", "green").fadeIn().delay(2000).fadeOut();
                        } else {
                            cartMessage.text("‚ùå " + response.message).css("color", "red").fadeIn().delay(2000).fadeOut();
                        }
                    },
                    error: function() {
                        cartMessage.text("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà").css("color", "red").fadeIn().delay(2000).fadeOut();
                    }
                });
            });
        });
    
        // üì§ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        function shareProduct() {
            let productUrl = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: "{{ product.name }}",
                    text: "‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Æ‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô {{ product.seller.store_name }}",
                    url: productUrl
                }).then(() => console.log("Shared successfully!"))
                .catch(error => console.error("Error sharing:", error));
            } else {
                navigator.clipboard.writeText(productUrl);
                alert("üìã ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
            }
        }
    
    </script>
</body>
</html>