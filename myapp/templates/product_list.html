{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>

    <!-- ‚úÖ CSS -->
    <link rel="stylesheet" href="{% static 'styles/product_list.css' %}">
    <link rel="stylesheet" href="{% static 'styles/navbar.css' %}">

    <!-- ‚úÖ Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- üå∏ Navbar -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="{% url 'home' %}">
                    <img src="{% static 'media/logo.jpg' %}" alt="Shop Logo">
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}" class="nav-link">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                <li><a href="{% url 'profile' request.user.id %}" class="nav-link">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a></li>
                <li><a href="{% url 'product_list' %}" class="nav-link {% if request.path == '/products/' %}active{% endif %}">üõçÔ∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                <li><a href="{% url 'order_history' %}" class="nav-link {% if request.path == '/order/history/' %}active{% endif %}">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                <li><a href="{% url 'cart' %}" class="nav-link {% if request.path == '/cart/' %}active{% endif %}">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <h2>üõç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

        <!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <input type="text" id="searchBox" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="filterProducts()">

        <!-- üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
        <div class="filter-section">
            <label for="categoryFilter">üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
            <select id="categoryFilter" class="form-select" onchange="filterProducts()">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="makeup">Makeup</option>
                <option value="skincare">Skincare</option>
                <option value="haircare">Hair Care</option>
                <option value="bodycare">Body Care</option>
                <option value="nailcare">Nail Care</option>
                <option value="wellness">Wellness</option>
                <option value="beautytools">Beauty Tools</option>
            </select>
        </div>

        <div class="row" id="productList">
            {% for product in products %}
            <div class="col-md-4 product-item" data-category="{{ product.category }}" data-name="{{ product.name }}">
                <div class="card">
                    <img src="{{ product.image.url }}" class="card-img-top">
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">üõç ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <a href="{% url 'store_detail' product.seller.id %}">{{ product.seller.store_name }}</a></p>
                        <p class="card-text">üìå ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ product.get_category_display }}</p>
                        <p class="card-text">üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 
                            {% if product.stock > 0 %}
                                {{ product.stock }}
                            {% else %}
                                <span class="out-of-stock">‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>
                            {% endif %}
                        </p>
                        <p class="card-text">üî• ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: <strong>{{ product.total_sold }}</strong> ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        <p class="text-primary">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{{ product.price }}</p>

                        <!-- üõí ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠) -->
                        <div class="btn-container">
                            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å -->
                            {% if product.stock > 0 %}
                                <button type="button" class="btn btn-success add-to-cart-btn" data-product-id="{{ product.id }}">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-secondary" disabled>
                                    ‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î
                                </button>
                            {% endif %}
                        
                            <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏õ‡∏∏‡πà‡∏° -->
                            <a href="{% url 'product_detail' product.id %}" class="btn btn-info">
                                üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p id="noProducts" class="text-center text-muted">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
            {% endfor %}
        </div>
    </main>

    <!-- ‚úÖ JavaScript -->
    <script>
        function filterProducts() {
            let searchInput = document.getElementById("searchBox").value.toLowerCase();
            let categoryFilter = document.getElementById("categoryFilter").value;
            let productItems = document.querySelectorAll(".product-item");
            let noProductsMessage = document.getElementById("noProducts");
            let hasVisibleProduct = false;

            productItems.forEach(item => {
                let productName = item.getAttribute("data-name").toLowerCase();
                let productCategory = item.getAttribute("data-category");

                let matchesSearch = productName.includes(searchInput);
                let matchesCategory = categoryFilter === "" || productCategory === categoryFilter;

                if (matchesSearch && matchesCategory) {
                    item.style.display = "block";
                    hasVisibleProduct = true;
                } else {
                    item.style.display = "none";
                }
            });

            noProductsMessage.style.display = hasVisibleProduct ? "none" : "block";
        }

        document.addEventListener("DOMContentLoaded", function () {
            let addToCartButtons = document.querySelectorAll(".add-to-cart-btn");

            addToCartButtons.forEach(button => {
                button.addEventListener("click", function () {
                    let productId = this.getAttribute("data-product-id");

                    fetch(`/cart/add/${productId}/`, {  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ "product_id": productId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                            document.getElementById("cart-count").textContent = data.cart_count;
                        } else {
                            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ: " + data.message);
                        }
                    })
                    .catch(error => console.error("Error:", error));
                });
            });
        });
    </script>
</body>
</html>
