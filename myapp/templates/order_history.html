{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>

    <!-- ‚úÖ Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles/order_his.css' %}">
    <link rel="stylesheet" href="{% static 'styles/navbar.css' %}">
    
    <!-- ‚úÖ Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- ‚úÖ JSON ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (reviewed_products) -->
    <!-- ‚úÖ JSON ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("‚úÖ JavaScript Loaded: review.js");
    
            let reviewedProductsRaw = `{{ reviewed_products|safe }}`.trim();  // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô space ‡∏´‡∏£‡∏∑‡∏≠ undefined
            let reviewedProducts = {};
    
            try {
                if (reviewedProductsRaw === "None" || reviewedProductsRaw === "" || reviewedProductsRaw === "null") {
                    reviewedProducts = {};  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô None ‡∏´‡∏£‡∏∑‡∏≠ Null ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Object ‡∏ß‡πà‡∏≤‡∏á
                } else {
                    reviewedProducts = JSON.parse(reviewedProductsRaw);
                }
            } catch (error) {
                console.error("‚ùå JSON Parsing Error:", error, "Data:", reviewedProductsRaw);
                reviewedProducts = {};  // ‚úÖ ‡πÉ‡∏ä‡πâ Object ‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤ JSON ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            }
    
            console.log("üîç DEBUG: Reviewed Products JSON after parsing ->", reviewedProducts);
        });
    </script>
    <!-- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô tab content -->
    <script>
      // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• reviewed_products
      console.log("Django template reviewed_products:", {{ reviewed_products|safe }});
    </script>
    <!-- ‚úÖ CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- ‚úÖ ‡πÇ‡∏´‡∏•‡∏î JavaScript -->
    <script src="{% static 'js/review.js' %}" defer></script>
    <script src="{% static 'js/edit_address.js' %}" defer></script>
    <script src="{% static 'js/orders_can.js' %}" defer></script>
</head>
<body>
    <input type="hidden" id="reviewed-products-data" value='{{ reviewed_products|safe }}'>

    <!-- ‚úÖ Navbar -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="{% url 'home' %}">
                    <img src="{% static 'media/logo.jpg' %}" alt="Shop Logo">
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}" class="nav-link">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                <li><a href="{% url 'profile' request.user.id %}" class="nav-link">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a></li>
                <li><a href="{% url 'product_list' %}" class="nav-link {% if request.path == '/products/' %}active{% endif %}">üõçÔ∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
                <li><a href="{% url 'order_history' %}" class="nav-link {% if request.path == '/order/history/' %}active{% endif %}">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a></li>
                <li><a href="{% url 'cart' %}" class="nav-link {% if request.path == '/cart/' %}active{% endif %}">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</a></li>
            </ul>
        </nav>
    </header>
    
    

    <div class="container mt-4">
        <h2 class="title">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        <!-- üîπ Bootstrap Tabs -->
        <ul class="nav nav-tabs mt-3">
            <li class="nav-item">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingOrders">üì¶ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedOrders">‚úÖ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="refund-tab" data-bs-toggle="tab" data-bs-target="#refundOrders">üîÑ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#allOrders">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </li>            
        </ul>

        <!-- üîπ Tab Content -->
        <div class="tab-content mt-3">
            <!-- üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
            <div class="tab-pane fade show active" id="pendingOrders">
                {% if pending_orders %}
                <table class="table table-bordered text-center">
                    <thead class="table-danger">
                        <tr>
                            <th>#</th>
                            <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                            <th>‡πÄ‡∏°‡∏∑‡∏≠‡∏á</th>
                            <th>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                            <th>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in pending_orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.seller.store_name }}</td>
                            <td>
                                <ul class="text-start">
                                    {% for item in order.order_items.all %}
                                        <li>{{ item.product.name }} x {{ item.quantity }} (‡∏ø{{ item.price_per_item }})</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>
                                <span id="order-address-{{ order.id }}">{{ order.shipping_address }}</span>
                                <button class="btn btn-warning btn-sm edit-address-btn"
                                    data-order-id="{{ order.id }}"
                                    data-address="{{ order.shipping_address }}"
                                    data-city="{{ order.city }}"
                                    data-postal-code="{{ order.postal_code }}"
                                    data-phone="{{ order.phone_number }}">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </td>                            
                            <td id="order-city-{{ order.id }}">{{ order.city }}</td>
                            <td id="order-postal-{{ order.id }}">{{ order.postal_code }}</td>
                            <td id="order-phone-{{ order.id }}">{{ order.phone_number }}</td>
                            <td>‡∏ø{{ order.total_price }}</td>
                            <td>
                                {% if order.payment_status == "pending" %}
                                    ‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                {% elif order.payment_status == "paid" %}
                                    ‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                {% else %}
                                    ‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                {% endif %}
                            </td>
                            <td>
                                {% if order.status == "pending" or order.status == "processing" %}
                                    <button class="btn btn-danger btn-sm cancel-order-btn"
                                        data-order-id="{{ order.id }}">
                                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                                    </button>
                                {% else %}
                                    -
                                {% endif %}
                            </td>                                                        
                            <td>
                                {% if order.status == "processing" %}
                                    üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                {% elif order.status == "shipped" %}
                                    üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                                {% else %}
                                    ‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                                {% endif %}
                            </td>
                            <td>
                                {% if order.status == "shipped" %}
                                    <a href="{% url 'confirm_delivery' order.id %}" class="btn btn-success btn-sm">
                                        ‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="text-center text-muted">üò¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</p>
                {% endif %}
            </div>
            <div class="modal fade" id="editAddressModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="order-id">
                            <div class="mb-2">
                                <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                <textarea id="edit-address" class="form-control" required></textarea>
                            </div>
                            <div class="mb-2">
                                <label>‡πÄ‡∏°‡∏∑‡∏≠‡∏á</label>
                                <input type="text" id="edit-city" class="form-control" required>
                            </div>
                            <div class="mb-2">
                                <label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                                <input type="text" id="edit-postal-code" class="form-control" required>
                            </div>
                            <div class="mb-2">
                                <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                                <input type="text" id="edit-phone" class="form-control" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="save-address-btn" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?</p>
                            <input type="hidden" id="cancel-order-id">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå ‡πÑ‡∏°‡πà</button>
                            <button id="confirm-cancel-btn" class="btn btn-danger">‚úÖ ‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
                        </div>
                    </div>
                </div>
            </div>
            
<!-- ‚úÖ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
<div class="tab-pane fade" id="completedOrders">
    {% if completed_orders %}
    <table class="table table-bordered text-center">
        <thead class="table-success">
            <tr>
                <th>#</th>
                <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                <th>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody>
            {% for order in completed_orders %}
            <tr>
                <td>#{{ order.id }}</td>
                <td>{{ order.seller.store_name }}</td>
                <td>
                    <ul class="text-start">
                        {% for item in order.order_items.all %}
                            <li>{{ item.product.name }} x {{ item.quantity }} (‡∏ø{{ item.price_per_item }})</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>{{ order.shipping_address }}</td>
                <td>{{ order.phone_number }}</td>
                <td>‡∏ø{{ order.total_price }}</td>
                <td>‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</td>
                <td>‚úÖ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td>
                <td>
                    {% for item in order.order_items.all %}
                        {% with key=item.product.id|stringformat:"s"|add:"_"|add:order.id|stringformat:"s" %}
                            <div class="d-inline-block mb-1">
                                <a href="{% url 'add_review' order.id item.product.id %}" 
                                    class="btn btn-primary btn-sm review-btn"
                                    data-order-id="{{ order.id }}"
                                    data-product-id="{{ item.product.id }}"
                                    id="review-btn-{{ order.id }}-{{ item.product.id }}">
                                    üìù ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                                </a>
                            </div>
                        {% endwith %}
                    {% endfor %}
                </td>                                                                              
                <td>
                    {% if order.order_items.exists %}  {# Check if there are any order items #}
                        <a href="{% url 'request_refund' order.id %}" class="btn btn-danger btn-sm refund-btn" data-order-id="{{ order.id }}">
                            üîÑ ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                        </a>
                    {% else %}
                        <span class="text-muted">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                    {% endif %}
                </td>                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-center text-muted">üò¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
    {% endif %}
</div>

            <!-- ‚úÖ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
            <!-- ‚úÖ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
<div class="tab-pane fade" id="refundOrders">
    {% if return_orders %}
    <table class="table table-striped text-center">
        <thead class="table-warning">
            <tr>
                <th>#</th>
                <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡∏™‡∏•‡∏¥‡∏õ</th>
                <th>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
        </thead>
        <tbody>
            {% for refund in return_orders %}
            <tr>
                <td>#{{ refund.order.id }}</td>
                <td>{{ refund.order.seller.store_name }}</td>
                <td>
                    <ul class="text-start">
                        {% if refund.item %}
                            <li>{{ refund.item.product.name }} x {{ refund.item.quantity }} (‡∏ø{{ refund.item.price_per_item }})</li>
                        {% else %}
                            {% for item in refund.order.order_items.all %}
                                <li>{{ item.product.name }} x {{ item.quantity }} (‡∏ø{{ item.price_per_item }})</li>
                            {% empty %}
                                ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                            {% endfor %}
                        {% endif %}
                    </ul>
                </td>
                <td>
                    {% if refund.status == "refunded" %}
                        ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    {% elif refund.status == "approved" %}
                        ‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    {% elif refund.status == "pending" %}
                        üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    {% elif refund.status == "rejected" %}
                        ‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                    {% elif refund.status == "confirmed" %}
                        üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
                    {% else %}
                        ‚ùå ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    {% endif %}
                </td>                
                
                <td>
                    {% if refund.refund_proof %}
                        <a href="{{ refund.refund_proof.url }}" target="_blank" class="btn btn-info btn-sm">üìú ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>
                    {% else %}
                        ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ
                    {% endif %}
                </td>
                <td>
                    {% if refund.status == "refunded" and not refund.confirmed_by_user %}
                        <a href="{% url 'confirm_refund_received' refund.id %}" class="btn btn-success">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</a>
                    {% elif refund.status == "confirmed" %}
                        ‚úî ‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
                    {% else %}
                        ‚ùå ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    {% endif %}
                </td>                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-center text-muted">üò¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
    {% endif %}
</div>
<!-- ‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
<div class="tab-pane fade" id="allOrders">
    {% if orders %}
    <table class="table table-bordered text-center">
        <thead class="table-info">
            <tr>
                <th>#</th>
                <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>#{{ order.id }}</td>
                <td>{{ order.seller.store_name }}</td>
                <td>
                    <ul class="text-start">
                        {% for item in order.order_items.all %}
                            <li>{{ item.product.name }} x {{ item.quantity }} (‡∏ø{{ item.price_per_item }})</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>{{ order.shipping_address }}</td>
                <td>{{ order.phone_number }}</td>
                <td>‡∏ø{{ order.total_price }}</td>
                <td>
                    {% if order.status == "pending" %}
                        ‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    {% elif order.status == "processing" %}
                        üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    {% elif order.status == "shipped" %}
                        üöö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                    {% elif order.status == "delivered" %}
                        ‚úÖ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    {% elif order.status == "cancelled" %}
                        ‚ùå ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    {% else %}
                        ‚ùå ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    {% endif %}
                </td>
                <td>
                    {% with refund=order.refund_requests.first %}
                        {% if refund %}
                            {% if refund.status == "refunded" %}
                                ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            {% elif refund.status == "approved" %}
                                ‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                            {% elif refund.status == "pending" %}
                                üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                            {% elif refund.status == "rejected" %}
                                ‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                            {% elif refund.status == "confirmed" %}
                                üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
                            {% else %}
                                ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                            {% endif %}
                        {% else %}
                            ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% if order.payment_status == "paid" and order.status in "pending,processing,shipped,cancelled" %}
                        <a href="{% url 'request_refund' order.id %}" class="btn btn-danger btn-sm">üîÑ ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a>
                    {% else %}
                        <span class="text-muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ</span>
                    {% endif %}
                </td>                
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-center text-muted">üò¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
    {% endif %}
</div>
<script>
    // ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ add_review.html
document.addEventListener("DOMContentLoaded", function() {
    const reviewForm = document.getElementById("review-form");
    
    if (reviewForm) {
        reviewForm.addEventListener("submit", function() {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            const productId = "{{ product.id }}";
            const orderId = "{{ order.id }}";
            const key = `${productId}_${orderId}`;
            
            let reviewedProducts = {};
            try {
                let storedReviews = localStorage.getItem("reviewedProducts");
                if (storedReviews) {
                    reviewedProducts = JSON.parse(storedReviews);
                }
            } catch (error) {
                console.error("‚ùå JSON Parsing Error:", error);
                reviewedProducts = {};
            }
            
            reviewedProducts[key] = true;
            localStorage.setItem("reviewedProducts", JSON.stringify(reviewedProducts));
        });
    }
});
</script>

</body>
</html>
