{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าหลัก</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Bootstrap CSS -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"> -->
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'styles/home.css' %}">

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="{% static 'js/post.js' %}" defer></script>
    <script src="{% static 'js/like.js' %}" defer></script>
    <script src="{% static 'js/share.js' %}" defer></script>
    <script src="{% static 'js/delete.js' %}" defer></script>
    <script src="{% static 'js/comment.js' %}" defer></script>
    <script src="{% static 'js/savelist.js' %}" defer></script>
    <script src="{% static 'js/follow.js' %}" defer></script>
    
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="{% static 'media/logo.jpg' %}" alt="Logo" class="logo-img">
            </div>
            <nav>
                <ul class="nav">
                    <li><a href="{% url 'home' %}" class="nav-link active"><i class="fas fa-home"></i> <span>หน้าหลัก</span></a></li>
                    <li><a href="{% url 'community_list' %}" class="nav-link"><i class="fas fa-users"></i> <span>ชุมชน</span></a></li>
                    <li><a href="{% url 'savelist' %}" class="nav-link"><i class="fas fa-bookmark"></i> <span>รายการบันทึก</span></a></li>
                    <li><a href="{% url 'profile' request.user.id %}" class="nav-link"><i class="fas fa-user"></i> <span>โปรไฟล์</span></a></li>
                    <li><a href="{% url 'product_list' %}" class="nav-link"><i class="fas fa-shopping-cart"></i> <span>รายการสินค้า</span></a></li>
                    <li><a href="{% url 'notifications' %}" class="nav-link"><i class="fas fa-bell"></i> <span>การแจ้งเตือน</span></a></li>
                </ul>
            </nav>
            <div class="welcome-logout">
                <p>ยินดีต้อนรับ, <b>{{ request.user.username }}</b></p>
                <form action="{% url 'logout' %}" method="post" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">ออกจากระบบ</button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Create Post Section -->
            <div class="create-post">
                <h5><i class="fas fa-edit me-2"></i>สร้างโพสต์ใหม่</h5>
                <form id="postForm" action="{% url 'create_post' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="content" class="form-control mb-3" placeholder="คุณกำลังคิดอะไรอยู่..." rows="3" required></textarea>
                    
                    <!-- Media Preview Area -->
                    <div id="imagePreview" class="mb-3"></div>
                    
                    <div class="d-flex gap-2">
                        <label for="postImages" class="btn">
                            <i class="fas fa-image me-1"></i> เพิ่มรูปภาพ
                        </label>
                        <input type="file" name="images" id="postImages" accept="image/*" multiple hidden>
                        
                        <label for="postVideos" class="btn">
                            <i class="fas fa-video me-1"></i> เพิ่มวิดีโอ
                        </label>
                        <input type="file" name="videos" id="postVideos" accept="video/*" multiple hidden>
                    </div>
                    
                    <button type="submit" class="btn btn-primary mt-3">
                        <i class="fas fa-paper-plane me-1"></i> โพสต์
                    </button>
                </form>
            </div>
            
            <!-- Posts Section -->
            <div class="posts">
                {% for post in posts %}
                    {% if post.is_reported == False %}
                        <div class="post" id="post-{{ post.id }}">
                            <!-- User Info -->
                            <div class="user-info d-flex align-items-center mb-3">
                                {% if post.user.member_profile.profile_picture %}
                                    <img src="{{ post.user.member_profile.profile_picture.url }}" class="profile-img me-2 rounded-circle" width="40" height="40">
                                {% else %}
                                    <img src="{% static 'images/default-profile.png' %}" class="profile-img me-2 rounded-circle" width="40" height="40">
                                {% endif %}
                                
                                <div class="d-flex flex-column">
                                    <b>{{ post.user.username }}</b>
                                    <small class="text-muted">{{ post.created_at|date:"F j, Y, g:i a" }}</small>
                                </div>
                                
                                <!-- Community Label -->
                                {% if post.is_community_post %}
                                    <div class="badge bg-primary text-white ms-2">
                                        <i class="fas fa-globe me-1"></i> Community Post
                                    </div>
                                {% endif %}
                                
                                <!-- Follow Button -->
                                {% if post.user.id != request.user.id %}
                                    <form method="POST" action="{% url 'follow_user' post.user.id %}" class="ms-auto follow-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm {% if post.user.id in following_users %}btn-danger{% else %}btn-outline-primary{% endif %} follow-btn"
                                            data-user-id="{{ post.user.id }}">
                                            {% if post.user.id in following_users %}
                                                <i class="fas fa-user-minus me-1"></i> ติดตามแล้ว
                                            {% else %}
                                                <i class="fas fa-user-plus me-1"></i> ติดตาม
                                            {% endif %}
                                        </button>
                                    </form>
                                {% endif %}
                            </div>

                            <!-- Post Content -->
                            <p class="mb-3">{{ post.content }}</p>

                            <!-- Post Media (Images & Videos) -->
                            {% if post.media.all %}
                                <div class="post-media mb-3">
                                    {% with media_count=post.media.all|length %}
                                        <div class="media-grid {% if media_count == 1 %}media-single{% elif media_count == 2 %}media-dual{% elif media_count == 3 %}media-triple{% elif media_count >= 4 %}media-quad{% endif %}">
                                            {% for media in post.media.all|slice:":4" %}
                                                <div class="media-item" data-bs-toggle="modal" data-bs-target="#mediaModal-{{ post.id }}-{{ forloop.counter }}">
                                                    {% if media.media_type == "image" %}
                                                        <img src="{{ media.file.url }}" class="rounded" alt="Post image">
                                                    {% elif media.media_type == "video" %}
                                                        <video src="{{ media.file.url }}" class="rounded" controls></video>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                            {% if media_count > 4 %}
                                                <div class="media-more">+{{ media_count|add:"-4" }}</div>
                                            {% endif %}
                                        </div>
                                    {% endwith %}
                                </div>
                                
                                <!-- Media Modal -->
                                <!-- แก้ไขส่วน Individual Media Modals เพื่อเพิ่มปุ่มปิด -->
                                {% for media in post.media.all %}
                                    <div class="modal fade" id="mediaModal-{{ post.id }}-{{ forloop.counter }}" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">
                                                    {% if media.media_type == "image" %}
                                                        <i class="fas fa-image me-2"></i> รูปภาพโพสต์
                                                    {% elif media.media_type == "video" %}
                                                        <i class="fas fa-video me-2"></i> วิดีโอโพสต์
                                                    {% endif %}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body text-center p-0 position-relative">
                                                <!-- เพิ่มปุ่มปิดแบบวงกลม -->
                                                <button type="button" class="close-button" data-bs-dismiss="modal">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                
                                                {% if media.media_type == "image" %}
                                                    <img src="{{ media.file.url }}" class="img-fluid">
                                                {% elif media.media_type == "video" %}
                                                    <video src="{{ media.file.url }}" controls class="img-fluid w-100"></video>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- แก้ไขส่วน Gallery Modal เพื่อเพิ่มปุ่มปิด -->
                                {% if post.media.all|length > 4 %}
                                <div class="modal fade" id="mediaGalleryModal-{{ post.id }}" tabindex="-1" aria-labelledby="mediaGalleryModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-images me-2"></i> รูปภาพทั้งหมด ({{ post.media.all|length }})
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body position-relative">
                                                <!-- เพิ่มปุ่มปิดแบบวงกลม -->
                                                <button type="button" class="close-button" data-bs-dismiss="modal">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                
                                                <div class="gallery-grid">
                                                    {% for media in post.media.all %}
                                                        <div class="gallery-item" onclick="openMediaModal('mediaModal-{{ post.id }}-{{ forloop.counter }}')">
                                                            {% if media.media_type == "image" %}
                                                                <img src="{{ media.file.url }}" class="rounded" alt="Post image">
                                                            {% elif media.media_type == "video" %}
                                                                <div class="video-thumbnail">
                                                                    <video src="{{ media.file.url }}" class="rounded"></video>
                                                                    <div class="play-overlay">
                                                                        <i class="fas fa-play-circle"></i>
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endif %} 

                            <!-- Actions -->
                            <div class="actions">
                                <button class="btn like-btn {% if post.id in liked_post_ids %}liked{% endif %}" data-post-id="{{ post.id }}">
                                    {% if post.id in liked_post_ids %}
                                        <i class="fas fa-heart"></i> ถูกใจแล้ว
                                    {% else %}
                                        <i class="far fa-heart"></i> ถูกใจ
                                    {% endif %}
                                </button>
                                <span id="like-count-{{ post.id }}" class="like-count-text">{{ post.likes.count }} ถูกใจ</span>
                                
                                <button class="btn share-btn" data-post-id="{{ post.id }}">
                                    <i class="fas fa-share-alt"></i> แชร์
                                </button>
                                
                                <button class="btn save-btn" data-post-id="{{ post.id }}">
                                    {% if post.id in saved_post_ids %}
                                        <i class="fas fa-bookmark"></i> <span class="save-text">ยกเลิกบันทึก</span>
                                    {% else %}
                                        <i class="far fa-bookmark"></i> <span class="save-text">บันทึก</span>
                                    {% endif %}
                                </button>

                                {% if request.user == post.user %}
                                    <a href="{% url 'edit_post' post.id %}" class="btn">
                                        <i class="fas fa-edit"></i> แก้ไข
                                    </a>                          
                                    <button class="btn btn-danger delete-btn" data-post-id="{{ post.id }}">
                                        <i class="fas fa-trash"></i> ลบ
                                    </button>
                                {% endif %}

                                {% if request.user != post.user %}
                                    <a href="{% url 'report_post' post.id %}" class="btn btn-warning">
                                        <i class="fas fa-flag"></i> รายงาน
                                    </a>
                                {% endif %}
                            </div>

                            <!-- Comments Section -->
                            <div class="comments">
                                <h6 class="comments-header">
                                    <i class="fas fa-comments me-1"></i> ความคิดเห็น 
                                    <span class="comments-count">{{ post.comments.all|length }}</span>
                                </h6>
                                
                                <div class="comments-list" id="comments-{{ post.id }}">
                                    {% for comment in post.comments.all %}
                                        <div class="comment-item d-flex" id="comment-{{ comment.id }}">
                                            <!-- Comment Avatar -->
                                            <div class="comment-avatar">
                                                {% if comment.user.member_profile.profile_picture %}
                                                    <img src="{{ comment.user.member_profile.profile_picture.url }}" alt="{{ comment.user.username }}">
                                                {% else %}
                                                    <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Comment Content -->
                                            <div class="comment-content">
                                                <div class="comment-bubble {% if comment.user == request.user %}own-comment{% endif %}">
                                                    <div class="comment-author">{{ comment.user.username }}</div>
                                                    <div class="comment-text">{{ comment.content }}</div>
                                                </div>
                                                
                                                <div class="comment-meta">
                                                    <span class="comment-time">{{ comment.created_at|timesince }} ที่แล้ว</span>
                                                    
                                                    {% if request.user == comment.user %}
                                                        <div class="comment-actions">
                                                            <button class="action-btn edit-comment" data-comment-id="{{ comment.id }}">
                                                                <i class="fas fa-edit"></i> แก้ไข
                                                            </button>
                                                            <button class="action-btn delete-comment" data-comment-id="{{ comment.id }}">
                                                                <i class="fas fa-trash"></i> ลบ
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="no-comments">
                                            <i class="fas fa-comment-slash"></i>
                                            <p>ยังไม่มีความคิดเห็น เป็นคนแรกที่แสดงความคิดเห็น!</p>
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Add Comment Form -->
                                <form class="comment-form" data-post-id="{{ post.id }}">
                                    {% csrf_token %}
                                    <div class="comment-form-avatar">
                                        {% if request.user.member_profile.profile_picture %}
                                            <img src="{{ request.user.member_profile.profile_picture.url }}" alt="{{ request.user.username }}">
                                        {% else %}
                                            <img src="{% static 'images/default-profile.png' %}" alt="Default Profile">
                                        {% endif %}
                                    </div>
                                    <div class="comment-input-wrapper">
                                        <input type="text" name="content" class="comment-input" placeholder="เขียนความคิดเห็น..." autocomplete="off">
                                        <button type="submit" class="comment-submit" disabled>
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </main>

        <!-- Recommended Products -->
        <aside class="recommendations">
            <h5><i class="fas fa-tags me-2"></i>แนะนำสินค้า</h5>
            <div class="product-grid">
                {% if products %}
                    {% for product in products %}
                        <div class="product-card">
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
                            <p class="mt-2 mb-1 fw-bold">{{ product.name }}</p>
                            <p class="text-primary mb-2">
                                <i class="fas fa-coins me-1"></i> ฿{{ product.price }}
                            </p>
                            <a href="{% url 'product_detail' product.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-shopping-bag me-1"></i> ดูรายละเอียด
                            </a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open text-muted mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted">ไม่มีสินค้าแนะนำในขณะนี้</p>
                    </div>
                {% endif %}
            </div>
        </aside>
    </div>

    <!-- JavaScript -->
    <script>
        // Modal handling - Fixed flickering issues
    document.addEventListener('DOMContentLoaded', function() {
        // Create a single modal instance for navigation
        let activeModal = null;
        let currentPostId = null;
        let currentIndex = 0;
        let totalItems = 0;
        
        // Handle clicks on media items
        document.querySelectorAll('.media-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('data-bs-target');
                openMediaModal(targetId);
            });
        });
        
        // Handle clicks on gallery items
        document.querySelectorAll('.gallery-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const modalId = this.getAttribute('data-media-id') || this.getAttribute('onclick').match(/'([^']+)'/)[1];
                openMediaModal(modalId);
            });
        });
        
        // Improved openMediaModal function
        window.openMediaModal = function(modalId) {
            // Extract post ID and item index from modalId
            const matches = modalId.match(/mediaModal-(\d+)-(\d+)/);
            if (matches) {
                currentPostId = matches[1];
                currentIndex = parseInt(matches[2]) - 1;
                
                // Count total items for this post
                const mediaItems = document.querySelectorAll(`[id^="mediaModal-${currentPostId}-"]`);
                totalItems = mediaItems.length;
                
                // If there's an active modal, hide it without animation
                if (activeModal) {
                    const modalElement = document.getElementById(activeModal);
                    if (modalElement) {
                        modalElement.classList.remove('show');
                        modalElement.style.display = 'none';
                    }
                }
                
                // Show the new modal without flicker
                const targetModal = document.getElementById(modalId);
                if (targetModal) {
                    // Setup navigation if multiple items
                    setupModalNavigation(targetModal);
                    
                    // Show modal smoothly
                    targetModal.style.display = 'block';
                    setTimeout(() => {
                        targetModal.classList.add('show');
                    }, 10);
                    
                    // Update active modal reference
                    activeModal = modalId;
                    
                    // Add event listeners for keyboard navigation
                    document.addEventListener('keydown', handleKeyNavigation);
                }
            }
        };
        
        // Setup modal navigation
        function setupModalNavigation(modal) {
            // Don't add navigation if already present or only one item
            if (modal.querySelector('.media-nav') || totalItems <= 1) {
                updateCounter(modal);
                return;
            }
            
            const modalBody = modal.querySelector('.modal-body');
            
            // Create navigation container
            const navContainer = document.createElement('div');
            navContainer.className = 'media-nav';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'nav-btn prev-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                navigateMedia(-1);
            });
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'nav-btn next-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                navigateMedia(1);
            });
            
            // Counter
            const counter = document.createElement('div');
            counter.className = 'media-counter';
            counter.textContent = `${currentIndex + 1} / ${totalItems}`;
            
            // Append elements
            navContainer.appendChild(prevBtn);
            navContainer.appendChild(counter);
            navContainer.appendChild(nextBtn);
            modalBody.appendChild(navContainer);
            
            // Add close button if not present
            // if (!modal.querySelector('.close-button')) {
            //     const closeButton = document.createElement('button');
            //     closeButton.className = 'close-button';
            //     closeButton.innerHTML = '<i class="fas fa-times"></i>';
            //     closeButton.addEventListener('click', function() {
            //         closeModal(modal);
            //     });
            //     modalBody.appendChild(closeButton);
            // }
        }
        
        // Update counter
        function updateCounter(modal) {
            const counter = modal.querySelector('.media-counter');
            if (counter) {
                counter.textContent = `${currentIndex + 1} / ${totalItems}`;
            }
        }
        
        // Media navigation function
        function navigateMedia(direction) {
            // Calculate new index with wrap-around
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = totalItems - 1;
            if (newIndex >= totalItems) newIndex = 0;
            
            // Close current modal
            if (activeModal) {
                const modal = document.getElementById(activeModal);
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
            }
            
            // Open new modal
            currentIndex = newIndex;
            const newModalId = `mediaModal-${currentPostId}-${newIndex + 1}`;
            
            // Show new modal without animation for smooth transition
            const newModal = document.getElementById(newModalId);
            if (newModal) {
                setupModalNavigation(newModal);
                newModal.style.display = 'block';
                setTimeout(() => {
                    newModal.classList.add('show');
                }, 10);
                activeModal = newModalId;
            }
        }
        
        // Handle keyboard navigation
        function handleKeyNavigation(e) {
            if (!activeModal) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    navigateMedia(-1);
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    navigateMedia(1);
                    e.preventDefault();
                    break;
                case 'Escape':
                    closeAllModals();
                    e.preventDefault();
                    break;
            }
        }
        
        // Close current modal
        function closeModal(modal) {
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                activeModal = null;
                document.removeEventListener('keydown', handleKeyNavigation);
            }
        }
        
        // Close all modals
        function closeAllModals() {
            document.querySelectorAll('.modal.show').forEach(modal => {
                closeModal(modal);
            });
        }
        
        // Close modals when clicking backdrop
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeAllModals();
            }
        });
        
        // Add ESC key handler for all modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals();
            }
        });
        
        // Enhanced image preview for image uploads
        const postImages = document.getElementById('postImages');
        const imagePreview = document.getElementById('imagePreview');
        
        if (postImages && imagePreview) {
            postImages.addEventListener('change', function() {
                imagePreview.innerHTML = '';
                
                if (this.files && this.files.length > 0) {
                    imagePreview.classList.add('d-flex', 'flex-wrap', 'gap-2');
                    
                    const fileCount = Math.min(this.files.length, 4);
                    
                    for (let i = 0; i < fileCount; i++) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imgPreview = document.createElement('div');
                            imgPreview.className = 'preview-item position-relative';
                            imgPreview.innerHTML = `
                                <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">`
                            ;
                            imagePreview.appendChild(imgPreview);
                            
                            // Remove image on close button click
                            imgPreview.querySelector('.btn-close').addEventListener('click', function() {
                                imgPreview.remove();
                                // Update preview if all images are removed
                                if (imagePreview.children.length === 0) {
                                    imagePreview.classList.remove('d-flex', 'flex-wrap', 'gap-2');
                                }
                            });
                        }
                        reader.readAsDataURL(this.files[i]);
                    }
                    
                    if (this.files.length > 4) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.className = 'more-indicator bg-light rounded p-2 d-flex align-items-center justify-content-center';
                        moreIndicator.style.width = '100px';
                        moreIndicator.style.height = '100px';
                        moreIndicator.innerHTML = `<span>+${this.files.length - 4} เพิ่มเติม</span>`;
                        imagePreview.appendChild(moreIndicator);
                    }
                }
            });
        }
        
        // Comment form functionality
        document.querySelectorAll('.comment-input').forEach(input => {
            input.addEventListener('input', function() {
                const submitBtn = this.closest('.comment-form').querySelector('.comment-submit');
                submitBtn.disabled = this.value.trim() === '';
            });
        });
});
        // เพิ่ม JavaScript เพื่อให้สามารถปิดโมดัลด้วยการคลิกที่พื้นหลัง
        document.addEventListener('DOMContentLoaded', function() {
            // ปิดโมดัลเมื่อคลิกที่พื้นหลัง
            document.addEventListener('click', function(event) {
                // ตรวจสอบว่ามีโมดัลที่กำลังแสดงอยู่หรือไม่
                const activeModal = document.querySelector('.modal.show');
                if (activeModal) {
                    // ตรวจสอบว่าคลิกที่พื้นหลังหรือไม่ (ไม่ได้คลิกที่เนื้อหาของโมดัล)
                    if (event.target.classList.contains('modal')) {
                        const modal = bootstrap.Modal.getInstance(activeModal);
                        if (modal) {
                            modal.hide();
                        }
                    }
                }
            });

            // เพิ่มปุ่มปิดในทุกๆ modal และให้สามารถกดปุ่ม ESC เพื่อปิดได้
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                // เพิ่ม event listener สำหรับการกดปุ่ม ESC
                modal.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                });
            });

            // เปลี่ยนการทำงานของฟังก์ชัน openMediaModal
            window.openMediaModal = function(modalId) {
                // ปิดโมดัลที่กำลังแสดงอยู่
                const galleryModal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                if (galleryModal) {
                    galleryModal.hide();
                }
                
                // แสดงโมดัลใหม่
                setTimeout(() => {
                    const targetModal = document.getElementById(modalId);
                    if (targetModal) {
                        const mediaModal = new bootstrap.Modal(targetModal);
                        mediaModal.show();
                        
                        // เพิ่มปุ่มปิดถ้ายังไม่มี
                        if (!targetModal.querySelector('.close-button')) {
                            const modalBody = targetModal.querySelector('.modal-body');
                            const closeButton = document.createElement('button');
                            closeButton.className = 'close-button';
                            closeButton.innerHTML = '<i class="fas fa-times"></i>';
                            closeButton.setAttribute('data-bs-dismiss', 'modal');
                            modalBody.appendChild(closeButton);
                        }
                    }
                }, 400);
            };
        });
        
        // Function to open individual media modals from the gallery
        function openMediaModal(modalId) {
            // Hide the gallery modal
            const galleryModal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            if (galleryModal) {
                galleryModal.hide();
            }
            
            // Show the individual media modal
            setTimeout(() => {
                const mediaModal = new bootstrap.Modal(document.getElementById(modalId));
                mediaModal.show();
            }, 400); // Small delay to allow the first modal to close
        }

        // Add navigation between media items
        document.addEventListener('DOMContentLoaded', function() {
            // Setup media navigation for each post
            const posts = document.querySelectorAll('.post');
            
            posts.forEach(post => {
                const postId = post.id.replace('post-', '');
                const mediaModals = document.querySelectorAll(`[id^="mediaModal-${postId}-"]`);
                
                if (mediaModals.length <= 1) return; // No need for navigation if there's only one media item
                
                mediaModals.forEach((modal, index) => {
                    // Add navigation buttons if not already present
                    if (!modal.querySelector('.media-nav')) {
                        const modalBody = modal.querySelector('.modal-body');
                        
                        // Create navigation container
                        const navContainer = document.createElement('div');
                        navContainer.className = 'media-nav';
                        
                        // Previous button
                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'nav-btn prev-btn';
                        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                        prevBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            navigateMedia(postId, index, -1, mediaModals.length);
                        });
                        
                        // Next button
                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'nav-btn next-btn';
                        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                        nextBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            navigateMedia(postId, index, 1, mediaModals.length);
                        });
                        
                        // Counter
                        const counter = document.createElement('div');
                        counter.className = 'media-counter';
                        counter.textContent = `${index + 1} / ${mediaModals.length}`;
                        
                        // Append elements
                        navContainer.appendChild(prevBtn);
                        navContainer.appendChild(counter);
                        navContainer.appendChild(nextBtn);
                        modalBody.appendChild(navContainer);
                    }
                });
            });
            // });

            // Function to navigate between media items
            function navigateMedia(postId, currentIndex, direction, totalItems) {
                // Calculate the new index
                let newIndex = currentIndex + direction;
                
                // Handle wrap-around
                if (newIndex < 0) newIndex = totalItems - 1;
                if (newIndex >= totalItems) newIndex = 0;
                
                // Hide current modal
                const currentModal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
                if (currentModal) {
                    currentModal.hide();
                }
                
                // Show the new modal
                setTimeout(() => {
                    const targetModalId = `mediaModal-${postId}-${newIndex + 1}`;
                    const targetModal = new bootstrap.Modal(document.getElementById(targetModalId));
                    targetModal.show();
                }, 400);
            }
        });

    </script>
</body>
</html>